<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Question-Specific Image Generation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .new-approach {
            background: rgba(0, 255, 136, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #00ff88;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #FFD700;
        }
        button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: none;
            color: #333;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .result {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 500px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            color: #FFD700;
        }
        .question-image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .question-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid transparent;
        }
        .question-card.has-image {
            border-color: #00ff88;
        }
        .question-card.no-image {
            border-color: #ff4444;
        }
        .question-text {
            font-size: 14px;
            margin-bottom: 10px;
            color: #FFD700;
            font-weight: bold;
        }
        .image-preview {
            width: 100%;
            height: 150px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 10px;
        }
        .image-description {
            font-size: 12px;
            color: #ccc;
            font-style: italic;
        }
        .success { color: #00ff88; font-weight: bold; }
        .warning { color: #ffaa00; font-weight: bold; }
        .error { color: #ff4444; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ NEW APPROACH: Question-Specific Images</h1>
        
        <div class="new-approach">
            <h2>‚úÖ What We Just Implemented</h2>
            <p><strong>Problem Solved:</strong> No more repeated images across questions!</p>
            
            <h3>üîÑ New Generation Flow:</h3>
            <ol>
                <li><strong>Step 1:</strong> Generate questions FIRST (without images)</li>
                <li><strong>Step 2:</strong> For each question, generate 1 specific image using question content</li>
                <li><strong>Step 3:</strong> Track used images to prevent duplicates</li>
                <li><strong>Step 4:</strong> Assign images directly to questions (1-to-1 mapping)</li>
            </ol>
            
            <h3>üéØ Expected Results:</h3>
            <ul>
                <li>‚úÖ Each question gets its own unique, relevant image</li>
                <li>‚úÖ No more repeated 4-panel cartoon images</li>
                <li>‚úÖ Images tailored to specific question content</li>
                <li>‚úÖ Better image-question alignment</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ Test the New Approach</h3>
            <p>Generate a worksheet using our improved question-specific image logic:</p>
            
            <button onclick="testNewApproach()">
                Test Question-Specific Images
            </button>
            
            <div id="result" class="result" style="display: none;"></div>
            <div id="question-images" class="question-image-grid" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä What to Look For</h3>
            <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px;">
                <h4 style="color: #00ff88;">‚úÖ Success Indicators:</h4>
                <ul>
                    <li><strong>Unique Images:</strong> Each question should have a different, relevant image</li>
                    <li><strong>Question Relevance:</strong> Images should relate to the specific question content</li>
                    <li><strong>No Repetition:</strong> No same image appearing across multiple questions</li>
                    <li><strong>Direct Assignment:</strong> Images should be directly embedded in questions</li>
                </ul>
                
                <h4 style="color: #ff4444;">‚ùå Failure Signs:</h4>
                <ul>
                    <li><strong>Repeated Images:</strong> Same image in multiple questions</li>
                    <li><strong>Generic Images:</strong> Images not related to question content</li>
                    <li><strong>Missing Images:</strong> Questions without any visual aids</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        async function testNewApproach() {
            const button = event.target;
            const resultDiv = document.getElementById('result');
            const imagesDiv = document.getElementById('question-images');
            
            button.disabled = true;
            button.textContent = 'Testing New Approach...';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">üîÑ Testing question-specific image generation...</div>';

            try {
                const response = await fetch('/api/generate-enhanced-worksheet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: 'Science',
                        subtopic: 'Animal Habitats',
                        gradeLevel: 'Grade 3',
                        learningObjective: 'Understanding where different animals live',
                        style: 'engaging'
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `‚ùå Error: ${data.error}`;
                } else {
                    const questions = data.questions || [];
                    const visualElements = data.visualElements || [];
                    
                    // Analyze question-image assignments
                    let questionsWithImages = 0;
                    let uniqueImages = new Set();
                    let questionImageAnalysis = [];
                    
                    questions.forEach((question, index) => {
                        const analysis = {
                            questionNumber: index + 1,
                            question: question.question.substring(0, 100) + '...',
                            hasImage: !!question.visualAid,
                            imageUrl: question.visualAid,
                            imageDescription: question.visualDescription
                        };
                        
                        if (question.visualAid) {
                            questionsWithImages++;
                            uniqueImages.add(question.visualAid);
                        }
                        
                        questionImageAnalysis.push(analysis);
                    });
                    
                    const uniqueImageCount = uniqueImages.size;
                    const duplicateCount = questionsWithImages - uniqueImageCount;
                    const successRate = questions.length > 0 ? Math.round((questionsWithImages / questions.length) * 100) : 0;
                    
                    // Display results
                    resultDiv.innerHTML = `
<span class="${duplicateCount === 0 && questionsWithImages > 0 ? 'success' : 'warning'}">
${duplicateCount === 0 && questionsWithImages > 0 ? 'üéâ SUCCESS: New approach working!' : '‚ö†Ô∏è Needs adjustment'}
</span>

üìä <strong>Question-Specific Image Analysis:</strong>
- Total Questions: ${questions.length}
- Questions with Images: ${questionsWithImages}
- Unique Images: ${uniqueImageCount}
- Duplicate Images: ${duplicateCount}
- Success Rate: ${successRate}%

üéØ <strong>Image Assignment Results:</strong>
${questionImageAnalysis.map((q, i) => 
  `Question ${q.questionNumber}: ${q.hasImage ? '‚úÖ Has unique image' : '‚ùå No image'}`
).join('\n')}

üîç <strong>Duplicate Check:</strong>
${duplicateCount === 0 ? 
  '‚úÖ No duplicate images detected - each question has unique visual!' :
  `‚ùå Found ${duplicateCount} duplicate images - still needs work`
}

üìà <strong>Overall Assessment:</strong>
${successRate >= 80 && duplicateCount === 0 ? 
  'üèÜ EXCELLENT: New approach successfully eliminates image repetition!' :
  successRate >= 60 ? 
    'üëç GOOD: Improvement shown, may need fine-tuning' :
    'üîß NEEDS WORK: Requires further optimization'
}
                    `;

                    // Display question-image grid
                    imagesDiv.innerHTML = '';
                    imagesDiv.style.display = 'grid';
                    
                    questionImageAnalysis.forEach(analysis => {
                        const card = document.createElement('div');
                        card.className = `question-card ${analysis.hasImage ? 'has-image' : 'no-image'}`;
                        
                        card.innerHTML = `
                            <div class="question-text">Q${analysis.questionNumber}: ${analysis.question}</div>
                            ${analysis.hasImage ? 
                                `<img src="${analysis.imageUrl}" alt="Question image" class="image-preview">
                                 <div class="image-description">${analysis.imageDescription || 'Question-specific image'}</div>` :
                                '<div style="height: 150px; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666;">No Image</div>'
                            }
                        `;
                        
                        imagesDiv.appendChild(card);
                    });
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            } finally {
                button.disabled = false;
                button.textContent = 'Test Question-Specific Images';
            }
        }
    </script>
</body>
</html>
