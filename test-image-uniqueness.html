<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé® Image Duplication Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #FFD700;
        }
        .fix-info {
            background: rgba(0, 255, 136, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 3px solid #00ff88;
        }
        button {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: none;
            color: #333;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .result {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .loading {
            text-align: center;
            color: #FFD700;
        }
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .image-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .image-item img {
            max-width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .image-item .label {
            font-size: 12px;
            color: #FFD700;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® Image Duplication Fix Test</h1>
        
        <div class="test-section">
            <h2>üêõ The Problem We Fixed</h2>
            <p>Your PDF showed the same image repeated hundreds of times because our system was generating identical content instead of unique, diverse images.</p>
            
            <div class="fix-info">
                <strong>üîß Fixes Implemented:</strong>
                <ul>
                    <li><strong>Unique IDs:</strong> Every image generation gets a timestamp + random ID</li>
                    <li><strong>Context Variation:</strong> Each image position gets unique context</li>
                    <li><strong>Prompt Randomization:</strong> Style variants and unique elements added</li>
                    <li><strong>Position Awareness:</strong> Images know their placement (header, inline, etc.)</li>
                    <li><strong>Index Tracking:</strong> Multiple images get sequential differentiation</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h3>üß™ Test: Generate Multiple Unique Images</h3>
            <p>This test will generate a worksheet that should have diverse, unique images instead of repeats.</p>
            
            <button onclick="testUniqueImages()">
                Generate Worksheet with Multiple Images
            </button>
            
            <div id="result1" class="result" style="display: none;"></div>
            <div id="images1" class="image-gallery" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîÑ Test: Same Topic, Different Results</h3>
            <p>Generate the same worksheet multiple times to verify we get different images each time:</p>
            
            <button onclick="testVariability()">
                Test Image Variability (Same Topic)
            </button>
            
            <div id="result2" class="result" style="display: none;"></div>
            <div id="images2" class="image-gallery" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä Analysis</h3>
            <div id="analysis" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        async function testUniqueImages() {
            const button = event.target;
            const resultDiv = document.getElementById('result1');
            const imagesDiv = document.getElementById('images1');
            
            button.disabled = true;
            button.textContent = 'Generating...';
            resultDiv.style.display = 'block';
            imagesDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">üé® Generating worksheet with unique images...</div>';
            imagesDiv.innerHTML = '';

            try {
                const response = await fetch('/api/generate-ultra-advanced-worksheet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: 'Science',
                        subtopic: 'Animal Habitats',
                        gradeLevel: 'Grade 4',
                        learningObjective: 'Understanding animal environments',
                        style: 'engaging'
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `‚ùå Error: ${data.error}`;
                } else {
                    let imageCount = 0;
                    let uniqueUrls = new Set();
                    
                    if (data.visualElements && data.visualElements.length > 0) {
                        data.visualElements.forEach((visual, index) => {
                            if (visual.url) {
                                imageCount++;
                                uniqueUrls.add(visual.url);
                                
                                const imageItem = document.createElement('div');
                                imageItem.className = 'image-item';
                                imageItem.innerHTML = `
                                    <img src="${visual.url}" alt="${visual.description}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SW1hZ2UgVW5hdmFpbGFibGU8L3RleHQ+PC9zdmc+'">
                                    <div class="label">
                                        Image ${index + 1}: ${visual.type}<br>
                                        ${visual.placement}<br>
                                        Method: ${visual.method || 'Unknown'}
                                    </div>
                                `;
                                imagesDiv.appendChild(imageItem);
                            }
                        });
                    }
                    
                    const uniqueCount = uniqueUrls.size;
                    const duplicateCount = imageCount - uniqueCount;
                    
                    resultDiv.innerHTML = `
‚úÖ <strong>Worksheet Generated Successfully!</strong>

üìä <strong>Image Uniqueness Analysis:</strong>
- Total Images Generated: ${imageCount}
- Unique Images: ${uniqueCount}
- Duplicate Images: ${duplicateCount}
- Uniqueness Rate: ${imageCount > 0 ? Math.round((uniqueCount / imageCount) * 100) : 0}%

üéØ <strong>Expected Result:</strong> 100% unique images (no duplicates)
${duplicateCount === 0 ? 'üéâ SUCCESS: All images are unique!' : '‚ö†Ô∏è WARNING: Some duplicate images detected'}

üìã <strong>Visual Elements:</strong>
${data.visualElements?.map((v, i) => `- Image ${i + 1}: ${v.type} (${v.placement}) via ${v.method || 'unknown'}`).join('\n') || 'No visual elements found'}

üß† <strong>Strategy Used:</strong>
- Content Type: ${data.educationalStrategy?.contentType || 'N/A'}
- Difficulty: ${data.educationalStrategy?.difficultyLevel || 'N/A'}/10
- Visual Requirements: ${data.educationalStrategy?.visualRequirements?.length || 0} planned
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            } finally {
                button.disabled = false;
                button.textContent = 'Generate Worksheet with Multiple Images';
            }
        }

        async function testVariability() {
            const button = event.target;
            const resultDiv = document.getElementById('result2');
            const imagesDiv = document.getElementById('images2');
            
            button.disabled = true;
            button.textContent = 'Testing Variability...';
            resultDiv.style.display = 'block';
            imagesDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading">üîÑ Generating same topic multiple times...</div>';
            imagesDiv.innerHTML = '';

            try {
                const requests = Array(3).fill(null).map(() => 
                    fetch('/api/generate-ultra-advanced-worksheet', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            topic: 'Math',
                            subtopic: 'Addition and Subtraction',
                            gradeLevel: 'Grade 2',
                            learningObjective: 'Basic arithmetic skills',
                            style: 'fun'
                        })
                    })
                );

                const responses = await Promise.all(requests);
                const dataArray = await Promise.all(responses.map(r => r.json()));
                
                let allUrls = new Set();
                let totalImages = 0;
                
                dataArray.forEach((data, runIndex) => {
                    if (data.visualElements) {
                        data.visualElements.forEach((visual, imageIndex) => {
                            if (visual.url) {
                                totalImages++;
                                allUrls.add(visual.url);
                                
                                const imageItem = document.createElement('div');
                                imageItem.className = 'image-item';
                                imageItem.innerHTML = `
                                    <img src="${visual.url}" alt="${visual.description}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjEwMCIgeT0iNzUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SW1hZ2UgVW5hdmFpbGFibGU8L3RleHQ+PC9zdmc+'">
                                    <div class="label">
                                        Run ${runIndex + 1}, Image ${imageIndex + 1}<br>
                                        ${visual.type} (${visual.method || 'unknown'})
                                    </div>
                                `;
                                imagesDiv.appendChild(imageItem);
                            }
                        });
                    }
                });
                
                const uniqueCount = allUrls.size;
                const variabilityRate = totalImages > 0 ? Math.round((uniqueCount / totalImages) * 100) : 0;
                
                resultDiv.innerHTML = `
‚úÖ <strong>Variability Test Complete!</strong>

üìä <strong>Cross-Generation Analysis:</strong>
- Total Images (3 runs): ${totalImages}
- Unique Images: ${uniqueCount}
- Variability Rate: ${variabilityRate}%

üéØ <strong>Expected Result:</strong> High variability (>80% unique)
${variabilityRate >= 80 ? 'üéâ EXCELLENT: High image variability!' : 
  variabilityRate >= 60 ? 'üëç GOOD: Decent variability' : 
  '‚ö†Ô∏è NEEDS IMPROVEMENT: Low variability detected'}

üìà <strong>Quality Assessment:</strong>
${variabilityRate >= 90 ? '- Images are highly unique across generations' :
  variabilityRate >= 70 ? '- Images show good variation with minor overlap' :
  '- Images may be too similar, need more randomization'}

üîç <strong>Analysis:</strong>
This test shows whether our uniqueness fixes prevent the same images from appearing when generating the same topic multiple times.
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
            } finally {
                button.disabled = false;
                button.textContent = 'Test Image Variability (Same Topic)';
            }
        }
    </script>
</body>
</html>
